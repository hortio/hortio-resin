<!doctype html>
<html lang="ru">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="vendor/aframe.min.js"></script>
  <script src="vendor/aframe-ar.js"></script>
  <script>
    // Use local URL for EPSON glasses and global everywhere else
    const apiUrl =
      navigator.userAgent.includes("EMBT3C") ? 'http://192.168.0.101/state.json' :
      'https://0df65f4d56c4166b4ebc9fa4d6f7ce67.resindevice.io/state.json';

    // navigator.userAgent
    // Public API url: 'https://0df65f4d56c4166b4ebc9fa4d6f7ce67.resindevice.io/state.json';
    // Local API url: 'http://192.168.0.101/state.json';

    document.addEventListener("DOMContentLoaded", function (event) {
      const notification = document.querySelector("#notification");

      // Lock orientation
      const showNotification = () => {
        if (window.innerHeight > window.innerWidth) {
          notification.setAttribute("class", "")
        } else {
          notification.setAttribute("class", "hidden")
        }
      }

      window.addEventListener("resize", showNotification);

      screen.lockOrientationUniversal = screen.lockOrientation || screen.mozLockOrientation || screen.msLockOrientation;
      if (typeof (screen.lockOrientationUniversal) === 'function') {
        screen.lockOrientationUniversal("landscape")
      }

      const updateData = () => {
        fetch(apiUrl)
          .then(function (response) {
            return response.json();
          })
          .then(function (data) {
            // Day of cycle
            const dayOfCycle = data.cycle.day;
            const daysOfCycle = document.querySelectorAll(".day-of-cycle");
            daysOfCycle.forEach((d) => {
              d.setAttribute("value", dayOfCycle)
            });

            // Phase description
            const phaseDescriptions = document.querySelectorAll(".phase-description");
            let phaseImageId = "#p4";

            if (dayOfCycle < 4) {
              phaseImageId = "#p1"
            } else if (dayOfCycle < 10) {
              phaseImageId = "#p2"
            } else if (dayOfCycle < 19) {
              phaseImageId = "#p3"
            } else {
              phaseImageId = "#p4"
            }

            phaseDescriptions.forEach((phaseDescription) => {
              phaseDescription.setAttribute("src", phaseImageId)
            });

            // Sensors
            const sensors = {
              "l1-h": "%",
              "l1-t": "°C",
              "l0-h": "%",
              "l0-t": "°C",
              "solution-ec": "mS/cm",
              "solution-ph": ""
            }

            for (var sensor in sensors) {
              if (sensors.hasOwnProperty(sensor)) {
                let unit = sensors[sensor];
                const sensorElements = document.querySelectorAll("." + sensor);
                sensorElements.forEach((s) => {
                  s.setAttribute("value", data.sensors[sensor].value + unit)
                });
              }
            }
          });
      }

      updateData();

      setInterval(updateData, 600000);
    });

  </script>
  <style>
    .hidden {
      display: none;
    }
  </style>
</head>

<body style='margin : 0px; overflow: hidden;'>
  <div style='position: fixed; top: 0px; left: 0px; height: 100%; width:100%; text-align: center; z-index: 1; background: #fffd;'
    class="hidden" id="notification">
    <h1>Пожалуйста, разверните телефон горизонтально!</h1>
  </div>

  <a-scene arjs='debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;' vr-mode-ui="enabled: false">
    <!-- Assets  -->
    <a-assets>
      <img id="p1" src="images/p1.png">
      <img id="p2" src="images/p2.png">
      <img id="p3" src="images/p3.png">
      <img id="p4" src="images/p4.png">
      <img id="top" src="images/top.png">
      <img id="bottom" src="images/bottom.png">
    </a-assets>

    <!-- Level 0, Top, Old Marker -->
    <a-marker type='barcode' value='33' size="0.033">
      <a-image position="3 0 -2" rotation="-90 0 0" scale="0.7 1 1" width="14" height="7" src="#top">
        <a-image class="phase-description" position="3 1.2 0.4" width="4" height="0.35" src="#p4"></a-image>
        <a-text class="day-of-cycle" width="1.8" wrap-count="9" align="right" position="-4.7 1.18 0.4" value="0" color="#111"
          transparent="false" alpha-test="1"></a-text>
        <a-text class="l0-t" width="1.8" wrap-count="9" align="left" position="-1.3 -0.5 0.4" value="0°C" color="#111"
          transparent="false" alpha-test="1"></a-text>
        <a-text class="l0-h" width="1.8" wrap-count="9" align="left" position="-1.3 -1 0.4" value="0%" color="#111"
          transparent="false" alpha-test="1"></a-text>
        <a-text class="solution-ph" width="1.8" wrap-count="9" align="left" position="-1.3 -2.6 0.4" value="0" color="#111"
          transparent="false" alpha-test="1"></a-text>
        <a-text class="solution-ec" width="1.8" wrap-count="9" align="left" position="-1.3 -3 0.4" value="0mS/cm" color="#111"
          transparent="false" alpha-test="1"></a-text>
      </a-image>
    </a-marker>

    <!-- Level 0, Top, New Marker (Left) -->
    <a-marker type='barcode' value='7' size="0.033">
      <a-image position="2 0 -0.8" rotation="-90 0 0" scale="0.35 0.5 0.5" width="14" height="7" src="#top">
        <a-image class="phase-description" position="3 1.2 0.4" width="4" height="0.35" src="#p4"></a-image>
        <a-text class="day-of-cycle" width="1.8" wrap-count="9" align="right" position="-4.7 1.18 0.4" value="0" color="#111"
          transparent="false" alpha-test="1"></a-text>
        <a-text class="l0-t" width="1.8" wrap-count="9" align="left" position="-1.3 -0.5 0.4" value="0°C" color="#111"
          transparent="false" alpha-test="1"></a-text>
        <a-text class="l0-h" width="1.8" wrap-count="9" align="left" position="-1.3 -1 0.4" value="0%" color="#111"
          transparent="false" alpha-test="1"></a-text>
        <a-text class="solution-ph" width="1.8" wrap-count="9" align="left" position="-1.3 -2.6 0.4" value="0" color="#111"
          transparent="false" alpha-test="1"></a-text>
        <a-text class="solution-ec" width="1.8" wrap-count="9" align="left" position="-1.3 -3 0.4" value="0mS/cm" color="#111"
          transparent="false" alpha-test="1"></a-text>
      </a-image>
    </a-marker>

    <!-- Level 1, Bottom, Old Marker -->
    <a-marker type='barcode' value='5'>
      <a-image position="-2 0 -2" rotation="-90 0 0" scale="0.7 1 1" width="14" height="7" src="#bottom">
        <a-image class="phase-description" position="3 1.2 0.4" width="4" height="0.35" src="#p4"></a-image>
        <a-text class="day-of-cycle" width="1.8" wrap-count="9" align="right" position="-4.7 1.18 0.4" value="0" color="#111"
          transparent="false" alpha-test="1"></a-text>
        <a-text class="l1-t" width="1.8" wrap-count="9" align="left" position="-1.3 -0.5 0.4" value="0°C" color="#111"
          transparent="false" alpha-test="1"></a-text>
        <a-text class="l1-h" width="1.8" wrap-count="9" align="left" position="-1.3 -1 0.4" value="0%" color="#111"
          transparent="false" alpha-test="1"></a-text>
        <a-text class="solution-ph" width="1.8" wrap-count="9" align="left" position="-1.3 -2.6 0.4" value="0" color="#111"
          transparent="false" alpha-test="1"></a-text>
        <a-text class="solution-ec" width="1.8" wrap-count="9" align="left" position="-1.3 -3 0.4" value="0mS/cm" color="#111"
          transparent="false" alpha-test="1"></a-text>
      </a-image>
    </a-marker>

    <!-- Level 1, Bottom, New Marker (Right) -->
    <a-marker type='barcode' value='25'>
      <a-image position="-2 0 -0.8" rotation="-90 0 0" scale="0.35 0.5 0.5" width="14" height="7" src="#bottom">
        <a-image class="phase-description" position="3 1.2 0.4" width="4" height="0.35" src="#p4"></a-image>
        <a-text class="day-of-cycle" width="1.8" wrap-count="9" align="right" position="-4.7 1.18 0.4" value="0" color="#111"
          transparent="false" alpha-test="1"></a-text>
        <a-text class="l1-t" width="1.8" wrap-count="9" align="left" position="-1.3 -0.5 0.4" value="0°C" color="#111"
          transparent="false" alpha-test="1"></a-text>
        <a-text class="l1-h" width="1.8" wrap-count="9" align="left" position="-1.3 -1 0.4" value="0%" color="#111"
          transparent="false" alpha-test="1"></a-text>
        <a-text class="solution-ph" width="1.8" wrap-count="9" align="left" position="-1.3 -2.6 0.4" value="0" color="#111"
          transparent="false" alpha-test="1"></a-text>
        <a-text class="solution-ec" width="1.8" wrap-count="9" align="left" position="-1.3 -3 0.4" value="0mS/cm" color="#111"
          transparent="false" alpha-test="1"></a-text>
      </a-image>
    </a-marker>
  </a-scene>
</body>
<a-entity camera></a-entity>

</html>